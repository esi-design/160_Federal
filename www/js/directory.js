// Local data - updated 1/26/2017
var LocD ='[{"id":"166","company":"A.T. KEARNEY, INC","floor":"FLOOR 3","person":""},{"id":"75","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":""},{"id":"203","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Jeffrey Cicolini, Partner"},{"id":"204","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Thomas Muldoon, Partner"},{"id":"205","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Sorie Kaba, Partner"},{"id":"206","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Jeffrey Mead, Partner"},{"id":"207","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Richard Weiner, Partner"},{"id":"208","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Matthew Troiano, Partner"},{"id":"209","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Nicole Zompa, Partner"},{"id":"210","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Amanda Pelcher"},{"id":"211","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Andrew Puricelli"},{"id":"212","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"David Consigli, Jr."},{"id":"213","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Emily McGinnis"},{"id":"214","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Jeanie Gorlovsky-Schepp"},{"id":"215","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Jill Foley"},{"id":"216","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Justin Leroux"},{"id":"217","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Katie Belanger"},{"id":"218","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Matthew McGinnis"},{"id":"219","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Olga Yasinnik"},{"id":"221","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Kevin Quinn"},{"id":"225","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Thomas Perruna"},{"id":"227","company":"ALEXANDER, ARONSON, FINNING","floor":"Floor 16","person":"Richard ONeil"},{"id":"92","company":"AMTRUST E&S INSURANCE","floor":"Floor 3","person":""},{"id":"168","company":"ARTLERY, LLC","floor":"FLOOR 1","person":""},{"id":"93","company":"BARTON GILMAN LLP","floor":"Floor 10","person":""},{"id":"94","company":"BARTON GILMAN LLP","floor":"Floor 10","person":"Robert M. Elmer"},{"id":"95","company":"BARTON GILMAN LLP","floor":"Floor 10","person":"Greg Vanden-Eykel"},{"id":"96","company":"BARTON GILMAN LLP","floor":"Floor 10","person":"Pamela Slater Gilman"},{"id":"97","company":"BARTON GILMAN LLP","floor":"Floor 10","person":"Brendan T. Malvey"},{"id":"98","company":"BARTON GILMAN LLP","floor":"Floor 10","person":"Edward D. Shoulkin"},{"id":"69","company":"BLONDHAIR, INC","floor":"HIGH STREET","person":""},{"id":"101","company":"CITIZENS RESOURCES, LLC","floor":"Floor 18","person":""},{"id":"103","company":"CLOVER FAST FOOD, INC","floor":"HIGH STREET","person":""},{"id":"182","company":"COLLIERS INTERNATIONAL","floor":"FLOOR 10","person":""},{"id":"116","company":"CONGRESS DENTAL GROUP","floor":"FEDERAL STREET","person":"Robert Page, D.M.D"},{"id":"169","company":"CONGRESS DENTAL GROUP","floor":"FEDERAL STREET","person":""},{"id":"117","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":""},{"id":"118","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Michael P. Antonelli"},{"id":"119","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Marc D. Bello"},{"id":"120","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Barbara T. Damon"},{"id":"121","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Glenn A. Gates, JD"},{"id":"122","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Jonathan P. Gorski"},{"id":"123","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"William F. Healey"},{"id":"124","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Denis C. Higgins"},{"id":"125","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Kerry A. Johnson"},{"id":"126","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Scott B. Kaplowitch"},{"id":"127","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"William D. Mahoney"},{"id":"128","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Timothy J. O Connor"},{"id":"129","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Robert P. O Connor"},{"id":"130","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Alfonso A. Perillo"},{"id":"131","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Jason R. Pierce"},{"id":"132","company":"EDELSTEIN & COMPANY","floor":"Floor 9","person":"Christopher S. Swain"},{"id":"200","company":"ESI Test Tenant","floor":"Floor 12","person":""},{"id":"175","company":"FIRST REPUBLIC BANK","floor":"FEDERAL STREET","person":""},{"id":"176","company":"FIRST REPUBLIC BANK","floor":"FLOOR 8","person":""},{"id":"137","company":"FORT HILL BARBER","floor":"LOBBY","person":"Lynn Provitola"},{"id":"170","company":"FORT HILL BARBER SHOP","floor":"FLOOR 1","person":""},{"id":"177","company":"HARE REALTY","floor":"FLOOR 23","person":""},{"id":"173","company":"M. ROBINSON COMPANY PC","floor":"FLOOR 6","person":""},{"id":"222","company":"M. ROBINSON COMPANY PC","floor":"FLOOR 6","person":"Deborah Robinson"},{"id":"223","company":"M. ROBINSON COMPANY PC","floor":"FLOOR 6","person":"Morris Robinson"},{"id":"224","company":"M. ROBINSON COMPANY PC","floor":"FLOOR 6","person":"Yechiel Robinson"},{"id":"140","company":"MASSACHUSETTS HOUSING PARTNERSHIP","floor":"Floor 2","person":""},{"id":"139","company":"MEFA","floor":"Floor 4","person":""},{"id":"141","company":"NEWS MART","floor":"ATRIUM","person":"Buddha Maharjan"},{"id":"171","company":"NEWS MART","floor":"LOBBY","person":""},{"id":"142","company":"NISSENBAUM HICKEY LLC","floor":"Floor 24","person":""},{"id":"143","company":"NISSENBAUM HICKEY LLC","floor":"Floor 24","person":"Gerald L. Nissenbaum"},{"id":"144","company":"NISSENBAUM HICKEY LLC","floor":"Floor 24","person":"Madeline M. Celletti"},{"id":"145","company":"NISSENBAUM HICKEY LLC","floor":"Floor 24","person":"Wendy O. Hickey"},{"id":"146","company":"NOBLE FINANCIAL CAPITAL MARKETS","floor":"Floor 21","person":"Richard Giles"},{"id":"147","company":"QUABBIN CAPITAL","floor":"Floor 6","person":""},{"id":"148","company":"QUABBIN CAPITAL","floor":"Floor 6","person":"Steven A. Leese"},{"id":"149","company":"QUABBIN CAPITAL","floor":"Floor 6","person":"John I. Snow III"},{"id":"31","company":"RACKEMANN STRATEGIC CONSULTING","floor":"Floor 15","person":"Steven C. Davis"},{"id":"2","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":""},{"id":"3","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Jesse W. Abair"},{"id":"4","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Lauren D. Armstrong"},{"id":"5","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Daniel J. Bailey"},{"id":"6","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Francesco A. De Vito"},{"id":"7","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Albert M. Fortier, Jr."},{"id":"8","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Stuart T. Freeland"},{"id":"9","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Richard J. Gallogly"},{"id":"10","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Ellen M. Harrington"},{"id":"11","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Brian M. Hurley"},{"id":"12","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Kurt A. James"},{"id":"13","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Matthew J. Leonard"},{"id":"14","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"J. David Leslie"},{"id":"15","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Sanford M. Matathia"},{"id":"16","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Louis C. Miller"},{"id":"17","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Maura E. Murphy"},{"id":"18","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Michael F. O Connell"},{"id":"19","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Nancy G. O Donnell"},{"id":"20","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Gareth I. Orsmond"},{"id":"21","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Daniel J. Ossoff"},{"id":"22","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Donald R. Pinto, Jr."},{"id":"23","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Alan B. Rubenstein."},{"id":"24","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Johanna Schneider"},{"id":"25","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Eric A. Smith"},{"id":"26","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Janet M. Smith"},{"id":"27","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Jeffrey J. Upton"},{"id":"28","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"James A. Wachta"},{"id":"29","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Lucy W. West"},{"id":"30","company":"RACKEMANN, SAWYER & BREWSTER","floor":"Floor 15","person":"Laurence M. Yorra"},{"id":"172","company":"RAYMOND PERSONAL TAILOR","floor":"FEDERAL STREET","person":""},{"id":"32","company":"RAYMOND PERSONAL TAILOR ","floor":"FEDERAL STREET","person":"Raymond Buckley"},{"id":"178","company":"RISK STRATEGIES","floor":"FLOOR 2","person":""},{"id":"39","company":"ROCKPORT CAPITAL PARTNERS","floor":"Floor 18","person":""},{"id":"40","company":"ROCKPORT PARTNERS","floor":"Floor 18","person":"Alexander Ellis III"},{"id":"41","company":"ROCKPORT PARTNERS","floor":"Floor 18","person":"Janet James"},{"id":"42","company":"ROCKPORT PARTNERS","floor":"Floor 18","person":"William E. James"},{"id":"43","company":"ROCKPORT PARTNERS","floor":"Floor 18","person":"Charles J. McDermott"},{"id":"44","company":"ROCKPORT PARTNERS","floor":"Floor 18","person":"David Prend"},{"id":"45","company":"ROCKPORT PARTNERS","floor":"Floor 18","person":"Stoddard Wilson"},{"id":"46","company":"STONE PHOTO","floor":"FEDERAL STREET","person":""},{"id":"1","company":"TAURUS MANAGEMENT SERVICES, LLC","floor":"LOBBY","person":""},{"id":"174","company":"TAURUS MANAGEMENT SERVICES, LLC","floor":"LOBBY","person":"Michael Ostiguy"},{"id":"179","company":"TAURUS MANAGEMENT SERVICES, LLC","floor":"LOBBY","person":"Michael Tibbetts"},{"id":"180","company":"TAURUS MANAGEMENT SERVICES, LLC","floor":"LOBBY","person":"Mildred Wong"},{"id":"181","company":"TAURUS MANAGEMENT SERVICES, LLC","floor":"LOBBY","person":"Karen Boylan"},{"id":"67","company":"TETRA TECH, INC","floor":"Floor 3","person":""},{"id":"165","company":"THE SHEPARD LAW FIRM","floor":"FLOOR 13","person":""},{"id":"68","company":"TIFFIN & TIFFIN","floor":"Floor 6","person":"James B. Tiffin"},{"id":"167","company":"TIFFIN & TIFFIN","floor":"FLOOR 6","person":""},{"id":"70","company":"TURAN CORPORATION","floor":"Floor 21","person":""},{"id":"72","company":"VISIONCARE 2000","floor":"HIGH STREET","person":""},{"id":"73","company":"WILKINS INVESTMENT COUNSEL","floor":"Floor 17","person":""}]';

$(document).ready(function(){

	$('input').on('focus', function(e) {
	    e.preventDefault(); e.stopPropagation();
	    window.scrollTo(0,0); 
	});
	
    $('input,textarea').focus(function () {
        $(this).data('placeholder', $(this).attr('placeholder'))
               .attr('placeholder', '');
    }).blur(function () {
        $(this).attr('placeholder', $(this).data('placeholder'));
    });
    
    $('.hover').bind('touchstart touchend', function(e) {
        e.preventDefault();
        $(this).toggleClass('hover_effect');
    });
    
    $('.logo').click(function(e){
	    e.preventDefault();
		window.location.hash = '#';
    });

    render(window.location.hash);
    $.support.cors=true;
    $.mobile.allowCrossDomainPages=true;

    var oReq = new XMLHttpRequest();
    var tokens =[];
    var next =[];
    var info_div;
    var values =[];
    var Ldata = [];
    var status;
	var variableUrl;

	variableUrl = 'js/variables.json';
	
	$.ajax({
		url: variableUrl,
	    dataType: "text",
		success: function(data) {
			var json = $.parseJSON(data);
			var gold = json['variables'][0]['gold'];
// 			console.log(gold);
			$('.container__line--top, .container__line--bottom').css({'background-color': gold});
			$('#page1 .touch h2, .ui-btn, #page3 .new-session h2').css({'border-top-color': gold, 'border-bottom-color': gold});
		}
	});
	
    var companyName;
    var companyLocation;

    //Input to change from keyboard-inputs
    var InputName;
    
    $('.delete').click(function(){
	    $('#data_Select, #data_Select_cmpny, #data_Select__ppl').filterable( "refresh" );
	    
    });
    
    

//================= Page 1 =================//

// An event handler with calls the render function on every hashchange.
$(window).on('hashchange', function(){
	window.scrollTo(0, 0);
	render(window.location.hash);
});


function render(url) {

	// Get the keyword from the url
	var temp = url.split('/')[0];

	// Hide whatever page is currently shown
	$('.container .page').removeClass('visible');

	var map = {

		// Home
		'': function() {
			renderHome();
		},
		
		'#': function() {
			renderHome();
		},

		'#page2': function() {

			// Get the index of which page we want to show and call the appropriate function.
			var index = url.split('/')[0];

			renderPage2();
		},
		
		'#page3': function() {

			var index = url.split('/')[0];

			renderPage3();
		}

	};

	// Execute the needed function depending on the url keyword (stored in temp).
	if(map[temp]){
		map[temp]();
	}
	// If the keyword isn't listed in the above - render the home page.
	else {
		renderHome();
	}

}
// ================== HOME PAGE =========================//
//attract loop
canvas();

function renderHome() {
	$('.black-bg').fadeIn();
	$('input').empty();
    $('#data_Select_cmpny').show(); 
    $('#data_Select, #data_Select__ppl, .keyboard').hide();
    $('.active').removeClass('active');
    $('input, #purpose, #purpose-option').removeClass('focus');
	$('input').val('');
	$('#searchForCollapsibleSetChildren').empty().val('');
    $("#data_Select, #data_Select_cmpny, #data_Select__ppl").animate({ scrollTop: 0 },400);
	$('#data_Select, #data_Select_cmpny, #data_Select__ppl').filterable( "refresh" );
	$('#data_Select, #data_Select_cmpny, #data_Select__ppl').animate({height : '580' },400); 
	
	var page = $('#page1');

	page.addClass('visible');
	$('#page1').on('click', function(e){
		e.preventDefault();
		window.location.hash = '#page2';
	});
}

function canvas(){
	var outputCanvas = document.getElementById('output'),
		output = outputCanvas.getContext('2d'),
		bufferCanvas = document.getElementById('buffer'),
		buffer = bufferCanvas.getContext('2d'),
		video = document.getElementById('video'),
		width = outputCanvas.width,
		height = outputCanvas.height,
		interval;
		
	function processFrame() {
		buffer.drawImage(video, 0, 0);

		var	image = buffer.getImageData(0, 0, width, height),
			imageData = image.data,
			alphaData = buffer.getImageData(0, height, width, height).data;
		
		for (var i = 3, len = imageData.length; i < len; i = i + 4) {
			imageData[i] = alphaData[i-1];
		}
		
		output.putImageData(image, 0, 0, 0, 0, width, height);
	}
	
	video.addEventListener('play', function() {
		clearInterval(interval);
		interval = setInterval(processFrame, 40)
	}, false);

	video.addEventListener('ended', function() {
		video.play();
	}, false);
	video.setAttribute("src", 'img/attract.mp4');		
}


// ================== PAGE 2 =========================//
function renderPage2() {
	$('#_cmpny, #_ppl, #_all, .space-page2').show();
	
	var page = $('#page2');
	$('.black-bg').fadeOut();

	page.addClass('visible');
	$('#data_Select_cmpny').show();
	$('#_cmpny').addClass('active');
	
	$('#page2 input').click(function(){
	$('#write').empty();
	InputName = '#searchForCollapsibleSetChildren';

         // Set the Keyboard
    $('#data_Select, #data_Select_cmpny, #data_Select__ppl').animate({height : '270' }, 400, function(){
	         $('.keyboard').fadeIn();
         });   
     });
}

$('#page2 .icon-close').on('click', function(e){
	e.preventDefault();
	$('#write').empty();
	$('#searchForCollapsibleSetChildren').empty().val('');
	$('#data_Select, #data_Select_cmpny, #data_Select__ppl').filterable("refresh");
});    

// ================== PAGE 3 =========================//
function renderPage3() {
	$('.keyboard, #_cmpny, #_ppl, #_all').fadeOut();
	
	// Hide whatever page is currently shown.
	var page = $('#page3');
	
	page.addClass('visible');
	
	$('#data_Select, #data_Select_cmpny, #data_Select__ppl').animate({height : '580' }, 400); 

	$('#page3').on('click', function(e){
		e.preventDefault();
		window.location.hash = '#';
	});
}


//================= Page 2 =================//
//Onload get directory data
var urlReq ="http://esidesigndev.com/160-federal/directory-handlers/building.php"

setInterval(function(){
	var data = true;
	location.reload(true);
	connectSql(urlReq, data);	
}, 1000 * 60 * 60);
//reload data every hour

var data = true;
connectSql(urlReq, data);	

//Show the company names and locations in the html element page 2     
$('#data_Select_cmpny').show();
$('#_cmpny').addClass('active');
$('#data_Select, #data_Select__ppl').hide();

//Show ByCompany page 2
$('#_cmpny').click(function(){
    $('.active').removeClass('active');
    $('#_cmpny').addClass('active');
    $('#data_Select, #data_Select__ppl').hide();
    $('#data_Select_cmpny').show();
//     getValues('#data_Select_cmpny');
});
//Show ByPeople page 2
$('#_ppl').click(function(){
    $('.active').removeClass('active');
    $('#_ppl').addClass('active');
    $('#data_Select, #data_Select_cmpny').hide();
    $('#data_Select__ppl').show();
//     getValues('#data_Select__ppl');
});
//Show default All page 2
$('#_all').click(function(){
    $('.active').removeClass('active');
    $('#_all').addClass('active');
    $('#data_Select').show();
    $('#data_Select_cmpny, #data_Select__ppl').hide();
//     getValues('#data_Select');
});

//================= Page 3 =================//


// ================= CONNECTION FUNCTIONS ================= //
 
// call get data
function connectSql(url, data){

    if (oReq != null) {
        oReq.open("GET",url + ((/\?/).test(url) ? "&" : "?") + (new Date()).getTime(), true);
        if(data == true) {
	    	oReq.onreadystatechange = handler;   
        }
        oReq.send();
    } else {
        window.console.log("NO INTERNET");
    }
}

// Get the data  -- xml 
function handler() {
    if (oReq.readyState == 4 /* complete */) {
        if (oReq.status >= 200 && (oReq.status < 300 || oReq.status === 304)) {
            var bval = oReq.responseText;
//             console.log(bval);
            console.log(oReq.status);
            convdata(bval);
            console.log('handler status: online');
        } else {
			convdata(LocD);
			console.log('handler status: no internet');
		}	
	}	
}

// Call to check for connection
/*
function sendData() {
   var localData = values;
   if (oReq.readyState == 4) {
		if (oReq.status >= 200 && (oReq.status < 300 || oReq.status === 304)) {
		    console.log(oReq.status);
		} else {
		    console.log("error");
		    Ldata.push(localData);
		}
	}
}
*/

// Call to check for connection
function reData() {
    if (oReq.readyState == 4 /* complete */) {
        if (oReq.status >= 200 && (oReq.status < 300 || oReq.status === 304)) {
            console.log(Ldata)
            if (Ldata.length < 1){
                console.log("SEND EMAIL HERE");
            }    
        } else {
            console.log("No Internet Connection");
        }
    }
}

// function to convert data into JSON -- Windows doesn't support jQueryAJAX, JSON.parse() or jQuery.parseJSON()
function convdata(data){

    var dt_one = data;
    var key=[],toJson=[],obj=[];

        // Converting data into JSON object

        if (dt_one.length > 11 ){ 

        // Parsing data -- Generate new array "obj" and new JSON "tokens"

        var filter_one= dt_one.replace(/([\$\w]+)\s*:/g, function(_, $1){return '"'+$1+'":'});
        var filter_two = filter_one.replace(/'([^']+)'/g, function(_, $1){return '"'+$1+'"'});
        var tnt = filter_two.split(/[{()}]+/);

        for(i in tnt){
            if( tnt[i].length > 2){
                key.push(tnt[i]);
            }
        }
        //console.log(key);
        for(i in key){
          var values = new Array();
          var keyOne =key[i].split(/","+/); 
          for (var j =0; j< keyOne.length; j++){
            var mkey = keyOne[j].split(":");
            var mkeytwo = mkey[1];
            if(mkeytwo!=undefined){   
                var res = mkeytwo.replace(/"/g, "");
                if (res.length >= 1){

                    values.push(res);
                }
            }
        }
        toJson.push(values);
    }

    for(i in toJson){
        if(toJson[i]!= undefined){
            obj.push(toJson[i])
        }
    }
    for (i in obj){
      var _company = String(obj[i][1]);
      var _location = String(obj[i][2]);
      var _people = String(obj[i][3]);
      tokens.push({'company': _company , 'location' : _location ,'people':_people});
  	}

    // To filter duplicates
    for(var i=1; i<obj.length; i++){
     	if(obj[i][1] != obj[i-1][1]){
        	next.push(obj[i]);
    	}
	}
        $('#_cmpny').addClass('active');
        getValues('#data_Select_cmpny');  
		getValues('#data_Select__ppl');
		getValues('#data_Select');    
    }

    else {
        //This is to send data
        console.log("Login Data");
    }
};

        
// Additional to get data. This is handy for reset the data load
function getValues(data){
    var c_Data = data;
    
    for(i in next){

    var clase = '';
    if (i <= 1) {
        clase = 'ui-collapsible ui-first-child';
    }
    if (i == next.length-1){
        clase = 'ui-collapsible ui-last-child';
    } else {
        clase = 'ui-collapsible';
    }

    var comp_wrapper = $(document.createElement("div")).attr({ 
        'data-role':"collapsible",
        'data-collapsed':'false',
        value:next[i][1],
        'data-inset': 'false',
        'data-content-theme':"false",
        'class': clase,
    });
    
    var comp_h3 =$(document.createElement('h3')).attr({
     'class': "ui-collapsible-heading",
	});
	
    var comp_link =$(document.createElement('a')).attr({
        'class': 'ui-collapsible-heading-toggle',
        'href': "#"
    }).text(String(next[i][1]));

    var comp_floor =$(document.createElement('h4')).attr({
        'id': 'floor',
        'class': 'ui-collapsible-heading-toggle',
                 //href: "#"
    }).text(String(next[i][2]));

    var ul_data = $(document.createElement("ul")).attr({
        'data-role':"listview", 'data-inset':"true",
        'class':"ui-listview",
        'id': "_list",
        'value': next[i][1] + "_Floor_" + next[i][1],
    });
    
    var cont_ul = $(document.createElement('div')).attr({
        'class' :"ui-collapsible-content",
        'aria-hidden' :"false"
    });

    $(comp_wrapper).removeClass("ui-screen-hidden");
    $(comp_h3).append(comp_link);
    $(comp_h3).append(comp_floor);
    $(cont_ul).append(ul_data);
    $(comp_wrapper).append(comp_h3);
    $(comp_wrapper).append(cont_ul);

    $(c_Data).append(comp_wrapper);

    var rep = new Array();
    var toSearch = String(next[i][1]);
    rep.push(toSearch);

    if(c_Data != '#data_Select_cmpny'){

        for(i in tokens){
            if(tokens[i].company == toSearch){
                if(tokens[i].people!=="undefined"){
                    rep.push(String(tokens[i].people));
                    var clasz = ''
                    if (rep.length <= 2){
                        clasz ='ui-li-static ui-body-inherit ui-first-child'
                    }
                    else {
                        clasz ='ui-li-static ui-body-inherit'
                    }
                    var list = $(document.createElement('li')).attr({
                        'data-filtertext':tokens[i].people,
                        'class':clasz,
                    });
                    var list_link = $(document.createElement('a')).attr({
                        'data-filtertext':tokens[i].people,
                        'class':clasz,
                        'href': '#',
                    }).text(String(tokens[i].people)).val(tokens[i].company + "|" + tokens[i].location);

                    $(list_link).click(function(){

                        inputText = $(this).text();
                        var NLoc = ($(this).val()).split("|");
                        console.log(NLoc);
                        
                        companyName = NLoc[0] + " | " + inputText;
                        companyLocation= NLoc[1];

                        confirmation(companyName,companyLocation);
							
                    });
                    $(list).append(list_link);
                    $(ul_data).append(list);
                }
            }
        }
    }
    rep.toString();
    var fil_a = rep.toString();  
    var fil_b= fil_a.replace(/,/g," ");
    $(comp_wrapper).attr({'data-filtertext' : fil_b })
   
    $(comp_h3).click(function(){

		var send_comp_link = $(this).find('a').text();
		var send_comp_floor = $(this).find('h4').text();
	
		confirmation(send_comp_link,send_comp_floor);
		
   });
}

}

function confirmation(company,location) {
		var url= "http://esidesigndev.com/160-federal/directory-handlers/visitorlog.php?company="+company;
		var data = false;
		connectSql(url, data)

		var noElevator = location.toUpperCase().search('FLOOR');
		
		if(noElevator == -1) {
			$('#direction').text('PLEASE PROCEED TO YOUR DESTINATION.');
		} else {
			$('#direction').text('PLEASE PROCEED TO THE ELEVATORS BEHIND YOU TO REACH YOUR DESTINATION.');
		}
		$('#company').text(company);
		$('#location').text(location); 

		window.location.hash = '#page3';    
		$('#searchForCollapsibleSetChildren').val(company);		
}

//===============KEYBOARD======================//
var $write = $('#write'),
symbol = false,
capslock = false;

$('.close-keyboard').click(function(){
	$('.keyboard').fadeOut(function(){
		$('#data_Select, #data_Select_cmpny, #data_Select__ppl').animate({height : '580' },400); 
	});
}); 


$('#keyboard li').click(function(){
	
	var searchLength = $('#write').html();
	if(searchLength.length >= 0) {
		$('#page2 .icon-close').fadeIn();
	} else {
		$('#page2 .icon-close').fadeOut();
	}

    var $this = $(this),
        character = $this.html(); // If it's a lowercase letter, nothing happens to this variable

        // Shift keys
        if ($this.hasClass('symbol-toggle')) {
	        
            $('.letter span').toggle();
            
			$(this).html() == "123" ? $(this).html('ABC') : $(this).html('123');

            symbol = (symbol === true) ? false : true;
            capslock = false;
            return false;
        }

        // Caps lock
        if ($this.hasClass('capslock')) {
            $('.letter').toggleClass('uppercase');
            capslock = true;
            return false;
        }

        // Delete
        if ($this.hasClass('delete')) {
			var html = $write.html();
			
			$write.html(html.substr(0, html.length - 1));
			$(InputName).val($write.val());
			$('#data_Select, #data_Select_cmpny, #data_Select__ppl').filterable( "refresh" );
          
            return false;
        }

        // Special characters
        if ($this.hasClass('letter')) character = $('span:visible', $this).html();
        if ($this.hasClass('space')) character = ' ';
        if ($this.hasClass('submit')) character = "\n";

        // Uppercase letter
        if ($this.hasClass('uppercase')) character = character.toUpperCase();

        // Remove shift once a key is clicked.
        if (symbol === true) {
            $('.letter span').toggle();
            if (capslock === false) $('.letter').toggleClass('uppercase');

            symbol = false;
        }

        // Add the character
        console.log($write.html() + character);
        $write.html($write.html() + character);
        $(InputName).val($write.val());
        $('#data_Select, #data_Select_cmpny, #data_Select__ppl').filterable( "refresh" );
   });

/*
// ================= RECOVER DATA ================= //	
setInterval(function(){
    var date = new Date();
    if(date.getHours() === 6 && date.getMinutes() === 00 && date.getSeconds() === 00){
        recovData();
		location.reload(true);
   }
}, 1000);
*/

// ================= HEARTBEAT ================= //		
setInterval(function(){	
	var url = "http://esidesigndev.com/160-federal/directory-handlers/heartbeat.php";
	var data = false;
	connectOnly(url, data);	
	location.reload(true);
}, 1000 * 60 * 3600);		
});


// ================= TIMEOUT ================= //
var timeout;
$(document).on("mousemove keydown click touchstart", function() {
    clearTimeout(timeout);
    timeout = setTimeout(function() {
         window.location = '#';
    }, 1000 * 60 * .5);
}).click();	